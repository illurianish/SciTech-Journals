'use client';

import React, { useState, useRef } from 'react';
import dynamic from 'next/dynamic';
import { Download, Edit, Save } from 'lucide-react';
import { Button } from '@/components/ui/button';

// Dynamically import the HandsontableExcel component to prevent SSR issues
const HandsontableExcel = dynamic(() => import('./HandsontableExcel'), {
  loading: () => <div className="p-4 text-center">Loading spreadsheet...</div>,
  ssr: false
});

interface FinancialNetCashFlowProps {
  propertyId: string;
}

const FinancialNetCashFlow: React.FC<FinancialNetCashFlowProps> = ({ propertyId }) => {
  const [isEditMode, setIsEditMode] = useState(false);
  const excelRef = useRef<any>(null);

  // Initial data for Net Cash Flow report
  const getNetCashFlowData = () => {
    return [
      ['Net Cash Flow for All Properties', 'Mar 2024', 'Apr 2024', 'May 2024', 'Jun 2024', 'Jul 2024', 'Aug 2024', 'Sep 2024', 'Oct 2024', 'Nov 2024', 'Dec 2024', 'Jan 2025', 'Feb 2025', 'Total'],
      ['Income', '', '', '', '', '', '', '', '', '', '', '', '', ''],
      ['Rents', '$12,500', '$12,500', '$12,500', '$12,500', '$12,750', '$12,750', '$12,750', '$12,750', '$12,750', '$12,750', '$12,750', '$12,750', '$150,000'],
      ['Section 8 Rents', '$2,400', '$2,400', '$2,400', '$2,400', '$2,400', '$2,400', '$2,400', '$2,400', '$2,400', '$2,400', '$2,400', '$2,400', '$28,800'],
      ['Short Term Rents', '$1,800', '$2,100', '$2,500', '$2,800', '$3,200', '$3,500', '$3,200', '$2,800', '$2,100', '$1,800', '$1,800', '$1,800', '$29,400'],
      ['Pet Fees', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$3,000'],
      ['Tenant Pass-Throughs', '$180', '$180', '$180', '$180', '$180', '$180', '$180', '$180', '$180', '$180', '$180', '$180', '$2,160'],
      ['Insurance Proceeds', '$0', '$0', '$0', '$0', '$0', '$3,500', '$0', '$0', '$0', '$0', '$0', '$0', '$3,500'],
      ['Cleaning & Other Upsells', '$150', '$150', '$150', '$150', '$150', '$150', '$150', '$150', '$150', '$150', '$150', '$150', '$1,800'],
      ['Total Rental Income', '$17,280', '$17,580', '$17,980', '$18,280', '$18,930', '$22,730', '$18,930', '$18,530', '$17,830', '$17,530', '$17,530', '$17,530', '$218,660'],
      ['General Income', '', '', '', '', '', '', '', '', '', '', '', '', ''],
      ['Application Fees', '$125', '$75', '$100', '$50', '$75', '$100', '$125', '$50', '$75', '$25', '$25', '$50', '$875'],
      ['Late Fees', '$75', '$100', '$50', '$75', '$50', '$25', '$75', '$100', '$50', '$75', '$50', '$25', '$750'],
      ['Laundry', '$320', '$310', '$330', '$315', '$325', '$340', '$330', '$320', '$310', '$300', '$300', '$300', '$3,800'],
      ['Storage', '$175', '$175', '$175', '$175', '$175', '$175', '$175', '$175', '$175', '$175', '$175', '$175', '$2,100'],
      ['Parking', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$3,000'],
      ['Stessa Interest', '$12', '$12', '$13', '$13', '$13', '$14', '$14', '$14', '$15', '$15', '$15', '$15', '$165'],
      ['Misc Interest', '$5', '$5', '$5', '$5', '$5', '$5', '$5', '$5', '$5', '$5', '$5', '$5', '$60'],
      ['Stessa Cash Back', '$18', '$15', '$22', '$19', '$17', '$23', '$20', '$16', '$18', '$21', '$14', '$17', '$220'],
      ['Total Other Income', '$980', '$942', '$945', '$902', '$910', '$932', '$994', '$930', '$898', '$866', '$834', '$837', '$10,970'],
      ['Total Income', '$18,260', '$18,522', '$18,925', '$19,182', '$19,840', '$23,662', '$19,924', '$19,460', '$18,728', '$18,396', '$18,364', '$18,367', '$229,630'],
      ['Operating Expenses', '', '', '', '', '', '', '', '', '', '', '', '', ''],
      ['General Admin & Other', '', '', '', '', '', '', '', '', '', '', '', '', ''],
      ['Advertising', '$50', '$50', '$75', '$75', '$100', '$100', '$75', '$75', '$50', '$50', '$50', '$50', '$800'],
      ['Background & Credit Checks', '$35', '$25', '$35', '$20', '$25', '$35', '$40', '$25', '$25', '$15', '$15', '$20', '$315'],
      ['Travel', '$0', '$0', '$150', '$0', '$0', '$0', '$200', '$0', '$0', '$150', '$0', '$0', '$500'],
      ['Mileage', '$45', '$35', '$60', '$40', '$35', '$45', '$55', '$40', '$35', '$50', '$30', '$35', '$505'],
      ['Meals', '$30', '$25', '$45', '$25', '$30', '$35', '$40', '$30', '$25', '$35', '$20', '$25', '$365'],
      ['Office Supplies & Postage', '$25', '$20', '$25', '$20', '$25', '$30', '$25', '$20', '$25', '$20', '$25', '$20', '$280'],
      ['Software Subscriptions', '$75', '$75', '$75', '$75', '$75', '$75', '$75', '$75', '$75', '$75', '$75', '$75', '$900'],
      ['HOA Dues', '$350', '$350', '$350', '$350', '$350', '$350', '$350', '$350', '$350', '$350', '$350', '$350', '$4,200'],
      ['Bank Fees', '$15', '$15', '$15', '$15', '$15', '$15', '$15', '$15', '$15', '$15', '$15', '$15', '$180'],
      ['Education', '$0', '$0', '$250', '$0', '$0', '$0', '$0', '$0', '$250', '$0', '$0', '$0', '$500'],
      ['Gifts', '$0', '$0', '$0', '$0', '$0', '$100', '$0', '$0', '$0', '$0', '$0', '$125', '$225'],
      ['Licenses', '$0', '$0', '$0', '$250', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$250'],
      ['Rent Concessions', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$250', '$0', '$0', '$0', '$250'],
      ['Total Admin & Other', '$625', '$595', '$1,080', '$870', '$655', '$785', '$875', '$630', '$1,100', '$760', '$580', '$715', '$9,270'],
      ['General Legal & Professional', '', '', '', '', '', '', '', '', '', '', '', '', ''],
      ['Legal', '$0', '$0', '$0', '$500', '$0', '$0', '$0', '$0', '$0', '$750', '$0', '$0', '$1,250'],
      ['Accounting', '$250', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$1,200', '$1,450'],
      ['Court Fees', '$0', '$0', '$0', '$150', '$0', '$0', '$0', '$0', '$0', '$175', '$0', '$0', '$325'],
      ['Eviction Fees', '$0', '$0', '$0', '$300', '$0', '$0', '$0', '$0', '$0', '$450', '$0', '$0', '$750'],
      ['Inspections', '$0', '$150', '$0', '$0', '$0', '$150', '$0', '$0', '$0', '$150', '$0', '$0', '$450'],
      ['Surveys', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['Appraisals', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['Total Legal & Professional', '$250', '$150', '$0', '$950', '$0', '$150', '$0', '$0', '$0', '$1,525', '$0', '$1,200', '$4,225'],
      ['General Insurance', '', '', '', '', '', '', '', '', '', '', '', '', ''],
      ['Rental Dwelling', '$420', '$420', '$420', '$420', '$420', '$420', '$420', '$420', '$420', '$420', '$420', '$420', '$5,040'],
      ['Rental Condo', '$180', '$180', '$180', '$180', '$180', '$180', '$180', '$180', '$180', '$180', '$180', '$180', '$2,160'],
      ['Flood', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['Hurricane', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['Earthquake', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['Liability', '$75', '$75', '$75', '$75', '$75', '$75', '$75', '$75', '$75', '$75', '$75', '$75', '$900'],
      ['Umbrella', '$50', '$50', '$50', '$50', '$50', '$50', '$50', '$50', '$50', '$50', '$50', '$50', '$600'],
      ['Total Insurance', '$725', '$725', '$725', '$725', '$725', '$725', '$725', '$725', '$725', '$725', '$725', '$725', '$8,700'],
      ['General Management Fees', '', '', '', '', '', '', '', '', '', '', '', '', ''],
      ['Property Management', '$1,385', '$1,407', '$1,438', '$1,457', '$1,507', '$1,807', '$1,513', '$1,479', '$1,425', '$1,399', '$1,397', '$1,398', '$17,612'],
      ['Service Calls', '$80', '$45', '$110', '$65', '$50', '$140', '$70', '$55', '$85', '$60', '$40', '$55', '$855'],
      ['Leasing Commissions', '$500', '$250', '$375', '$0', '$250', '$375', '$500', '$250', '$0', '$0', '$250', '$0', '$2,750'],
      ['Booking & Platform Fees', '$90', '$105', '$125', '$140', '$160', '$175', '$160', '$140', '$105', '$90', '$90', '$90', '$1,470'],
      ['Total Management Fees', '$2,055', '$1,807', '$2,048', '$1,662', '$1,967', '$2,497', '$2,243', '$1,924', '$1,615', '$1,549', '$1,777', '$1,543', '$22,687'],
      ['General Repairs & Maintenance', '', '', '', '', '', '', '', '', '', '', '', '', ''],
      ['Cleaning & Janitorial', '$225', '$225', '$225', '$225', '$225', '$225', '$225', '$225', '$225', '$225', '$225', '$225', '$2,700'],
      ['Painting', '$0', '$0', '$0', '$850', '$0', '$0', '$0', '$0', '$750', '$0', '$0', '$0', '$1,600'],
      ['Electrical Repairs', '$0', '$0', '$150', '$0', '$0', '$0', '$175', '$0', '$0', '$0', '$0', '$125', '$450'],
      ['Plumbing Repairs', '$0', '$275', '$0', '$0', '$0', '$200', '$0', '$0', '$0', '$180', '$0', '$0', '$655'],
      ['HVAC Repairs', '$0', '$0', '$0', '$420', '$0', '$0', '$0', '$350', '$0', '$0', '$0', '$0', '$770'],
      ['Appliance Repairs', '$0', '$150', '$0', '$0', '$175', '$0', '$0', '$0', '$0', '$125', '$0', '$0', '$450'],
      ['Roof Repairs', '$0', '$0', '$0', '$0', '$0', '$450', '$0', '$0', '$0', '$0', '$0', '$0', '$450'],
      ['Door & Window Repairs', '$0', '$0', '$175', '$0', '$0', '$0', '$0', '$0', '$0', '$150', '$0', '$0', '$325'],
      ['Other Repairs', '$75', '$50', '$125', '$85', '$60', '$90', '$70', '$65', '$55', '$80', '$45', '$50', '$850'],
      ['Security, Locks & Keys', '$40', '$25', '$35', '$30', '$25', '$45', '$35', '$30', '$20', '$25', '$15', '$25', '$350'],
      ['Pest', '$80', '$80', '$80', '$80', '$80', '$80', '$80', '$80', '$80', '$80', '$80', '$80', '$960'],
      ['Gardening & Landscaping', '$250', '$250', '$250', '$275', '$275', '$275', '$275', '$275', '$250', '$250', '$250', '$250', '$3,125'],
      ['Snow Removal', '$150', '$100', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$100', '$150', '$500'],
      ['Pool & Spa', '$120', '$120', '$150', '$150', '$180', '$180', '$180', '$150', '$150', '$120', '$0', '$0', '$1,500'],
      ['R&M Supplies', '$75', '$65', '$85', '$70', '$65', '$80', '$75', '$65', '$60', '$70', '$55', '$60', '$825'],
      ['R&M Permits & Inspections', '$0', '$0', '$0', '$0', '$0', '$175', '$0', '$0', '$0', '$0', '$0', '$0', '$175'],
      ['Labor', '$150', '$125', '$175', '$160', '$135', '$190', '$155', '$140', '$130', '$165', '$120', '$130', '$1,775'],
      ['Linens, Soaps, & Other Consumables', '$60', '$60', '$70', '$75', '$85', '$90', '$85', '$75', '$65', '$60', '$60', '$60', '$845'],
      ['Total Repairs & Maintenance', '$1,225', '$1,525', '$1,520', '$2,420', '$1,305', '$2,080', '$1,355', '$1,455', '$1,785', '$1,530', '$950', '$1,155', '$18,305'],
      ['General Taxes', '', '', '', '', '', '', '', '', '', '', '', '', ''],
      ['Property Taxes', '$1,250', '$1,250', '$1,250', '$1,250', '$1,250', '$1,250', '$1,250', '$1,250', '$1,250', '$1,250', '$1,250', '$1,250', '$15,000'],
      ['Special Assessments', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['City, State, & Local Taxes', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['Short Term Occupancy Taxes', '$90', '$105', '$125', '$140', '$160', '$175', '$160', '$140', '$105', '$90', '$90', '$90', '$1,470'],
      ['Federal Taxes', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['Tax Licenses & Registrations', '$0', '$0', '$0', '$0', '$150', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$150'],
      ['Total Taxes', '$1,340', '$1,355', '$1,375', '$1,390', '$1,560', '$1,425', '$1,410', '$1,390', '$1,355', '$1,340', '$1,340', '$1,340', '$16,620'],
      ['General Utilities', '', '', '', '', '', '', '', '', '', '', '', '', ''],
      ['Gas', '$180', '$160', '$125', '$95', '$75', '$70', '$75', '$90', '$125', '$165', '$185', '$190', '$1,535'],
      ['Electric', '$220', '$210', '$225', '$240', '$290', '$325', '$335', '$290', '$250', '$225', '$215', '$220', '$3,045'],
      ['Gas & Electric', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['Garbage & Recycling', '$95', '$95', '$95', '$95', '$95', '$95', '$95', '$95', '$95', '$95', '$95', '$95', '$1,140'],
      ['Telephone, Cable & Internet', '$150', '$150', '$150', '$150', '$150', '$150', '$150', '$150', '$150', '$150', '$150', '$150', '$1,800'],
      ['Water & Sewer', '$165', '$160', '$170', '$175', '$190', '$210', '$225', '$195', '$185', '$175', '$170', '$165', '$2,185'],
      ['Heating Oil', '$120', '$95', '$70', '$0', '$0', '$0', '$0', '$0', '$65', '$95', '$115', '$125', '$685'],
      ['Total Utilities', '$930', '$870', '$835', '$755', '$800', '$850', '$880', '$820', '$870', '$905', '$930', '$945', '$10,390'],
      ['Total Operating Expenses', '$7,150', '$7,027', '$7,583', '$8,772', '$7,012', '$8,512', '$7,488', '$6,944', '$7,450', '$8,334', '$6,302', '$7,623', '$90,197'],
      ['Net Operating Income', '$11,110', '$11,495', '$11,342', '$10,410', '$12,828', '$15,150', '$12,436', '$12,516', '$11,278', '$10,062', '$12,062', '$10,744', '$139,433'],
      ['Mortgage & Loan Expenses', '', '', '', '', '', '', '', '', '', '', '', '', ''],
      ['Mortgage Payment', '$3,500', '$3,500', '$3,500', '$3,500', '$3,500', '$3,500', '$3,500', '$3,500', '$3,500', '$3,500', '$3,500', '$3,500', '$42,000'],
      ['Mortgage Interest', '$2,800', '$2,795', '$2,790', '$2,785', '$2,780', '$2,775', '$2,770', '$2,765', '$2,760', '$2,755', '$2,750', '$2,745', '$33,270'],
      ['Mortgage Principal', '$700', '$705', '$710', '$715', '$720', '$725', '$730', '$735', '$740', '$745', '$750', '$755', '$8,730'],
      ['Other Loan Payment', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['Other Interest', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['Other Principal', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['Private Mortgage Insurance (PMI)', '$175', '$175', '$175', '$175', '$175', '$175', '$175', '$175', '$175', '$175', '$175', '$175', '$2,100'],
      ['Total Mortgages & Loans', '$3,675', '$3,675', '$3,675', '$3,675', '$3,675', '$3,675', '$3,675', '$3,675', '$3,675', '$3,675', '$3,675', '$3,675', '$44,100'],
      ['Capital Expenses', '', '', '', '', '', '', '', '', '', '', '', '', ''],
      ['New Roof', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['New Appliances', '$0', '$0', '$0', '$1,200', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$1,200'],
      ['New HVAC', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$4,500', '$0', '$0', '$0', '$0', '$4,500'],
      ['New Flooring & Carpet', '$0', '$0', '$0', '$0', '$0', '$2,800', '$0', '$0', '$0', '$0', '$0', '$0', '$2,800'],
      ['New Doors & Windows', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$1,500', '$0', '$0', '$0', '$1,500'],
      ['New Landscaping', '$0', '$0', '$1,800', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$1,800'],
      ['New Plumbing & Electrical', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$1,200', '$0', '$1,200'],
      ['New Furniture & Equipment', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$750', '$750'],
      ['Remodeling', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['Total Capital Expenses', '$0', '$0', '$1,800', '$1,200', '$0', '$2,800', '$0', '$4,500', '$1,500', '$0', '$1,200', '$750', '$13,750'],
      ['Net Cash Flow', '$7,435', '$7,820', '$5,867', '$5,535', '$9,153', '$8,675', '$8,761', '$4,341', '$6,103', '$6,387', '$7,187', '$6,319', '$81,583'],
      ['Transfers', '', '', '', '', '', '', '', '', '', '', '', '', ''],
      ['General Security Deposits', '$0', '$500', '$0', '$0', '$500', '$0', '$0', '$500', '$0', '$0', '$0', '$0', '$1,500'],
      ['Security Deposit Interest', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['General Transfers', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['Credit Card Payments', '$150', '$125', '$175', '$140', '$160', '$180', '$165', '$145', '$130', '$145', '$120', '$135', '$1,770'],
      ['Owner Distributions', '$7,000', '$7,000', '$5,000', '$5,000', '$8,000', '$8,000', '$8,000', '$3,500', '$5,500', '$6,000', '$6,500', '$6,000', '$75,500'],
      ['Owner Contributions', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['General Escrow Payments', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['Property Tax Escrows', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$250', '$3,000'],
      ['Insurance Escrows', '$125', '$125', '$125', '$125', '$125', '$125', '$125', '$125', '$125', '$125', '$125', '$125', '$1,500'],
      ['PMI Escrows', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['HOA Escrows', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['Down Payments', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['Taxes to Remit', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0', '$0'],
      ['Total Transfers', '$7,525', '$8,000', '$5,550', '$5,515', '$9,035', '$8,555', '$8,540', '$4,520', '$6,005', '$6,520', '$6,995', '$6,510', '$83,270'],
      ['', '', '', '', '', '', '', '', '', '', '', '', '', ''],
      ['Report Created: March 29, 2025 at 8:38 AM PDT', '', '', '', '', '', '', '', '', '', '', '', '', '']
    ];
  };

  // Handle edit mode toggle
  const handleEditClick = () => {
    setIsEditMode(!isEditMode);
    if (excelRef.current) {
      excelRef.current.toggleEditMode();
    }
  };

  // Handle export
  const handleExportClick = () => {
    if (excelRef.current) {
      excelRef.current.exportToExcel();
    }
  };

  // Handle save
  const handleSaveClick = () => {
    setIsEditMode(false);
    if (excelRef.current) {
      excelRef.current.handleSave();
    }
  };

  return (
    <div>
      <div className="mb-4 flex justify-end gap-2">
        {!isEditMode ? (
          <>
            <Button variant="outline" size="sm" onClick={handleEditClick}>
              <Edit className="h-4 w-4 mr-1" />
              Edit
            </Button>
            <Button size="sm" onClick={handleExportClick}>
              <Download className="h-4 w-4 mr-1" />
              Export
            </Button>
          </>
        ) : (
          <>
            <Button variant="outline" size="sm" onClick={handleEditClick}>
              Cancel
            </Button>
            <Button size="sm" onClick={handleSaveClick}>
              <Save className="h-4 w-4 mr-1" />
              Save
            </Button>
          </>
        )}
      </div>

      <HandsontableExcel
        ref={excelRef}
        data={getNetCashFlowData()}
        sheetName="Net Cash Flow"
        onSave={(data) => {
          console.log('Saving Net Cash Flow data for property:', propertyId);
          // Here you would typically save the data to your backend
          // For now, we just log it
        }}
      />
    </div>
  );
};

export default FinancialNetCashFlow; 