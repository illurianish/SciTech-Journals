{% extends 'side_bar.html' %}
{% load extras %}
{% block title %}Top Authors{% endblock %}

{% block htmlbody %}
<div class="app-content main-content mt-0">
  <div class="side-app">
    <div class="main-container container-fluid">

      <div class="page-header">
        <div>
          <h1 class="page-title">Top Authors (Unique)</h1>
        </div>
        <div class="ms-auto pageheader-btn">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="javascript:void(0);">Manage Data Central</a></li>
            <li class="breadcrumb-item active" aria-current="page">Top Authors</li>
          </ol>
        </div>
      </div>

      <div class="row row-sm">
        <div class="col-lg-12">
          <div class="card">

            {% if messages %}
              {% for message in messages %}
              <div class="container-fluid p-0">
                <div class="alert {{ message.tags }} alert-dismissible" role="alert">
                  <button type="button" class="close" data-bs-dismiss="alert" aria-label="Close">
                    <span aria-hidden="True">&times;</span>
                  </button>
                  {{ message }}
                </div>
              </div>
              {% endfor %}
            {% endif %}

            <div class="card-body">
              <form method="get" class="row g-3 mb-4">
                <div class="form-group col-md-3">
                  <select name="year" class="form-control select2 select2-show-search-single">
                    <option value="">-- All Years --</option>
                    {% for y in years %}
                      <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="form-group col-md-3">
                  <select name="group" class="form-control select2 select2-show-search-single">
                    <option value="">-- All Groups --</option>
                    {% for id, name in groups %}
                      <option value="{{ id }}" {% if id|stringformat:'s' == selected_group %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-md-3">
                  <input type="text" class="form-control" name="keyword"
                         placeholder="Keyword" value="{{ keyword }}">
                </div>

                <div class="col-md-3">
                  <input type="text" class="form-control" name="domain"
                         placeholder="Email domain (e.g. gmail.com)" value="{{ domain }}">
                </div>

                <div class="col-12 d-flex">
                  <button type="submit" class="btn btn-primary me-2">Filter</button>
                  <a href="{% url 'app:top_authors_report' %}" class="btn btn-secondary">Reset</a>
                </div>
              </form>

              <div class="mb-3">
                <a href="?{% if selected_year %}year={{ selected_year }}&{% endif %}{% if selected_group %}group={{ selected_group|urlencode }}&{% endif %}{% if keyword %}keyword={{ keyword|urlencode }}&{% endif %}{% if domain %}domain={{ domain|urlencode }}&{% endif %}export=csv" class="btn btn-outline-info me-2">ðŸ“„ Export CSV</a>

                <a href="?{% if selected_year %}year={{ selected_year }}&{% endif %}{% if selected_group %}group={{ selected_group|urlencode }}&{% endif %}{% if keyword %}keyword={{ keyword|urlencode }}&{% endif %}{% if domain %}domain={{ domain|urlencode }}&{% endif %}export=excel" class="btn btn-outline-success">ðŸ“Š Export Excel</a>
              </div>
            </div>

            <div class="card-header border-bottom">
              <h3 class="card-title">Authors (Unique)</h3>
            </div>

            <div class="card-body">
              {% if total_count %}
                <div class="mb-2">
                  <strong>Total Authors:</strong> {{ total_count }}
                </div>
              {% else %}
                <div class="mb-2 text-muted">
                  <strong>Total Authors:</strong> â€”
                  <span class="small">(omitted for speed)</span>
                </div>
              {% endif %}
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Author Name</th>
                      <th>Author Email</th>
                      <th>Country</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% if rows %}
                    {% for a in rows %}
                      <tr>
                        <td>{{ forloop.counter0|add:start_index|add:1 }}</td>
                        <td>{{ a.a_name }}</td>
                        <td>{{ a.a_email_norm }}</td>
                        <td>{{ a.author_country|default:"â€”" }}</td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="4" class="text-center">No data found.</td></tr>
                  {% endif %}
                </tbody>
                </table>
              </div>

              <!-- Fast pager (no COUNT()) -->
              <nav>
                <ul class="pagination">
                  {% if page|add:"-1" > 0 %}
                    <li class="page-item">
                      <a class="page-link"
                         href="?page={{ page|add:"-1" }}&year={{ selected_year }}&group={{ selected_group|urlencode }}&keyword={{ keyword|urlencode }}&domain={{ domain|urlencode }}">
                        Previous
                      </a>
                    </li>
                  {% else %}
                    <li class="page-item disabled"><span class="page-link">Previous</span></li>
                  {% endif %}

                  <li class="page-item active"><span class="page-link">Page {{ page }}</span></li>

                  {% if has_next %}
                    <li class="page-item">
                      <a class="page-link"
                         href="?page={{ page|add:"1" }}&year={{ selected_year }}&group={{ selected_group|urlencode }}&keyword={{ keyword|urlencode }}&domain={{ domain|urlencode }}">
                        Next
                      </a>
                    </li>
                  {% else %}
                    <li class="page-item disabled"><span class="page-link">Next</span></li>
                  {% endif %}
                </ul>
              </nav>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}
